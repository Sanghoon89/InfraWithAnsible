# 10.1 네트워크 IP 설정하기

## 상황
  - 기본 네트워크 이외의 네트워크 IP 설정을 앤서블을 이용해 설정

## 방법 찾기
  - 네트워크 정보 확인하고 네트워크 IP를 설정하려면
    + 페도라 계열 : ```nmcli``` 명령어 이용하여 설정
    + 데비안 계열 : ```netplan```이라는 파일을 통해 설정
  - VM에 네트워크 인터페이스를 하나씩 추가하고 IP 설정

## 사전 분석
  - ```nmcli``` 명령어는 ```community.general.nmcli```라는 모듈 제공
  - ```netplan```은 파일이므로 사전에 ```netplan``` 파일 구조를 확인하고 jinja2 템플릿으로 작성한다.




## 플레이북 설계
  - 인벤토리에 구성된 호스트 그룹과 호스트 정의
  - ```nmcli```(CentOS,RHEL) 모듈을 사용하는 롤과 ```netplan```(Ubuntu)을 사용하는 롤 구성
  - 운영체제의 종류에 따라 해당 롤을 호출하는 방식으로 메인 플레이북 설계
    + myrole.nmcli : 테스크만 구성
    + myrole.netplan : 템플릿, 태스크, 핸들러 구성
  - nmcli 롤
    + community.general.nmcli 모듈 이용하여 구현
    + ansible_facts 이용하여 외부로부터 입력받은 인터페이스명이 대상 호스트에 존재하는지 확인
  - netplan 롤
    + netplan 파일을 분석하여 어떤 식으로 작성할 것인지 대략적으로 적어두면 플레이북 개발 시 도움이 된다.
  - [네트워크 IP 설정 플레이북 설계](https://docs.google.com/presentation/d/1zG0envKk27-t223Vm1V20ksPz2qr9PQ-yqAR8W_fUXE/edit#slide=id.g2de1bcb5aec_0_104)
  - [네트워크 IP 설정 롤 설계](https://docs.google.com/presentation/d/1zG0envKk27-t223Vm1V20ksPz2qr9PQ-yqAR8W_fUXE/edit#slide=id.g2de1bcb5aec_0_135)

## 플레이북 개발
### 01. ansible.cfg, inventory
  ```sh
  # cat ansible.cfg
  [defaults]
  inventory = ./inventory
  remote_user = ansible
  ask_pass = false
  roles_path = ./roles

  [privilege_escalation]
  become = true
  become_method = sudo
  become_user = root
  become_ask_pass = false
  ```

### 02. inventory에 tnode 호스트 그룹만
  ```sh
  # cat inventory
  [tnode]
  tnode1-centos.com
  tnode2-Ubuntu.com
  tnode3-Rocky.com
  ```

### 03. 롤 생성 (```ansible-galaxy role init```)
  ```sh
  # myrole.nmcli
  ansible-galaxy role init --init-path ./roles myrole.nmcli
  # myrole.netplan
  ansible-galaxy role init --init-path ./roles myrole.netplan
  ```

### 04. vars/main.yml (롤에서 사용할 변수들 정의)
  - httpd_service : 설치될 패키지 정의
    + httpd, yum-utils 설치
  - repo_dir : 패키지를 다운로드할 Repository 경로
    + /repo
  - (Source) [vars/main.yml](./roles/myrole.httpd/vars/main.yml)

### 05. 환경 설정 파일(files/repo.conf) 생성
  - (Source) [file/repo.conf](./roles/myrole.httpd/files/repo.conf)

### 06. Package Repogitory 환경을 설정할 메인 태스크(tasks/main.yml) 작성
  - 설치된 패키지 2개 이상
  - loop 키워드를 이용하여 패키지 설치 구현
  - repo.conf 파일 복사된 후 notify 키워드를 이용하여 2개 이상의 핸들러 태스크 호출 (notify 키워드를 통해 여러 개의 핸들러 태스크 호출할 수 있다.)
  - (Source) [tasks/main.yml](./roles/myrole.httpd/tasks/main.yml)

### 07. 핸들러(handlers/main.yml) 작성
  - SELinux 컨텍스트 적용할 적합한 모듈 없음
    + ```ansible.builtin.command``` 모듈 이용하여 직접 명령어 실행
  - (Source) [handlers/main.yml](./roles/myrole.httpd/handlers/main.yml)

### 08. 마지막으로 롤 호출하는 메인 플레이북(config_repo.yml) 작성
  - ```failed_when``` 키워드 사용하여 ```ansible.builtin.uri```모듈 통해 체크한 Repository 사이트 호출 결과가 200이 아니면 실패 처리
  - 웹 서비스 체크하는 태스크는 롤이 전부 실행된 다음에 실행될 수 있도록 ```post_tasks``` 세션 이용
    + 만일 여기서 ```tasks```를 사용하면 롤을 실행하는 과정에서 발생하는 핸들러 태스크보다 먼저 실행되어 에러 발생
    + 핸들러가 모두 수행된 다음 웹 서비스를 체크할 수 있도록 특수 작업 세션인 ```post_tasks``` 사용
  - (Source) [config_repo.yml](./config.repo.yml)

## 플레이북 실행
### 01. 플레이북 문법 체크 (```ansible-playbook --syntax-check```)
  - > ```ansible-playbook --syntax-check config_repo.yml```

### 02. 플레이북 실행 (```ansible-playbook```)
  - 롤 태스크와 핸들러가 모두 수행된 후 메인 플레이북 웹 서비스 체크 수행됨
  - > ```ansible-playbook config_repo.yml```

### 03. 테스트를 위해 플레이북 여러 번 수행하는 경우 발생 - 앤서블은 이미 수행된 것은 상태 확인만 하고 재수행 하지 않음

